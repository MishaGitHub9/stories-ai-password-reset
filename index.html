<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–°–∫–∏–¥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—é</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: sans-serif; max-width: 400px; margin: 40px auto; padding: 20px; }
    input, button { width: 100%; margin-top: 10px; padding: 10px; }
    #status { margin-top: 20px; color: green; }
    #error { margin-top: 20px; color: red; }
  </style>
</head>
<body>
  <h2>–°–∫–∏–¥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—é</h2>

  <form id="reset-form" style="display: none;">
    <input type="password" id="new-password" placeholder="–ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å" required />
    <button type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏ –ø–∞—Ä–æ–ª—å</button>
  </form>

  <div id="status"></div>
  <div id="error"></div>

  <script>
    const supabase = supabase.createClient(
      "https://lkidcfdazjdhtykxiafp.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxraWRjZmRhempkaHR5a3hpYWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4MTAzMzEsImV4cCI6MjA2OTM4NjMzMX0.PA_4fAgYn2TV3_-DkmNFFRDYYRDCggeIPMWxphSlT70" // üîÅ –∑–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ —Å–≤—ñ–π
    );

    const form = document.getElementById("reset-form");
    const passwordInput = document.getElementById("new-password");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");

    function parseParams(str) {
      const p = {};
      const searchParams = new URLSearchParams(str.replace(/^#/, '').replace(/^\?/, ''));
      for (const [key, value] of searchParams.entries()) {
        p[key] = value;
      }
      return p;
    }

    async function main() {
      const hashParams = parseParams(window.location.hash);
      const searchParams = parseParams(window.location.search);

      let sessionSet = false;

      if (hashParams.access_token && hashParams.refresh_token) {
        const { error } = await supabase.auth.setSession({
          access_token: hashParams.access_token,
          refresh_token: hashParams.refresh_token,
        });
        if (error) {
          errorEl.textContent = "–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: " + error.message;
          return;
        }
        sessionSet = true;
      } else if (searchParams.token && searchParams.type === "recovery") {
        const { data, error } = await supabase.auth.verifyOtp({
          token: searchParams.token,
          type: "recovery",
        });
        if (error) {
          errorEl.textContent = "–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏: " + error.message;
          return;
        }
        sessionSet = true;
      }

      if (sessionSet) {
        form.style.display = "block";
        statusEl.textContent = "–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–∏–π –ø–∞—Ä–æ–ª—å";
      } else {
        errorEl.textContent = "–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —Ç–æ–∫–µ–Ω—É –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—é.";
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const newPassword = passwordInput.value;
      const { error } = await supabase.auth.updateUser({ password: newPassword });
      if (error) {
        errorEl.textContent = "–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –ø–∞—Ä–æ–ª—å: " + error.message;
      } else {
        statusEl.textContent = "–ü–∞—Ä–æ–ª—å —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ!";
        errorEl.textContent = "";
        form.reset();
        form.style.display = "none";
      }
    });

    main();
  </script>
</body>
</html>
